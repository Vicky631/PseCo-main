# PseCoä»£ç åº“åˆ†ææŠ¥å‘Š

## 1. ä»£ç åº“æ ¸å¿ƒåŠŸèƒ½

**PseCo (Point, Segment and Count)** æ˜¯ä¸€ä¸ªç”¨äº**ç±»æ— å…³ç›®æ ‡è®¡æ•°ï¼ˆClass-agnostic Object Countingï¼‰**çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå‘è¡¨åœ¨CVPR 2024ã€‚

### æ ¸å¿ƒç‰¹ç‚¹ï¼š
- **ç»“åˆä¸¤ä¸ªåŸºç¡€æ¨¡å‹**ï¼šSAM (Segment Anything Model) + CLIP
- **æ”¯æŒä¸¤ç§æ¨¡å¼**ï¼š
  - **Few-shotè®¡æ•°**ï¼šåŸºäºç¤ºä¾‹æ¡†ï¼ˆexample boxesï¼‰è¿›è¡Œè®¡æ•°
  - **Zero-shotè®¡æ•°**ï¼šåŸºäºç±»åˆ«åç§°ï¼ˆclass namesï¼‰è¿›è¡Œè®¡æ•°
- **ä¸‰æ­¥éª¤æµç¨‹**ï¼šPointï¼ˆç‚¹å®šä½ï¼‰â†’ Segmentï¼ˆåˆ†å‰²ï¼‰â†’ Countï¼ˆè®¡æ•°ï¼‰

### åº”ç”¨åœºæ™¯ï¼š
- å¯†é›†ç›®æ ‡è®¡æ•°ï¼ˆå¦‚äººç¾¤ã€è½¦è¾†ã€åŠ¨ç‰©ç­‰ï¼‰
- å°æ ·æœ¬/é›¶æ ·æœ¬ç›®æ ‡æ£€æµ‹
- å¤§è§„æ¨¡æ•°æ®é›†ï¼ˆFSC-147, COCO, LVISï¼‰

---

## 2. æ¨¡å‹çš„ä¸»è¦éƒ¨ä»¶

### 2.1 åŸºç¡€æ¨¡å‹ç»„ä»¶

1. **SAM (Segment Anything Model) - ViT-H**
   - åŠŸèƒ½ï¼šå›¾åƒç‰¹å¾æå–ã€ç›®æ ‡åˆ†å‰²ã€æ©ç ç”Ÿæˆ
   - ä½ç½®ï¼š`ops/foundation_models/segment_anything/`
   - ç”¨é€”ï¼šæå–å›¾åƒç‰¹å¾ã€ç”Ÿæˆå€™é€‰æ¡†å’Œæ©ç 

2. **CLIP (ViT-B/32)**
   - åŠŸèƒ½ï¼šè·¨æ¨¡æ€ç‰¹å¾æå–ï¼ˆå›¾åƒ/æ–‡æœ¬ï¼‰
   - ä½ç½®ï¼š`ops/foundation_models/clip/`
   - ç”¨é€”ï¼šæå–ç¤ºä¾‹æ¡†å›¾åƒç‰¹å¾ã€ç”Ÿæˆç±»åˆ«æ–‡æœ¬ç‰¹å¾

### 2.2 è‡ªå®šä¹‰æ¨¡å‹ç»„ä»¶

1. **PointDecoder** (`models.py`)
   - åŠŸèƒ½ï¼šåŸºäºSAMç‰¹å¾é¢„æµ‹ç›®æ ‡å…³é”®ç‚¹ï¼Œç”Ÿæˆçƒ­åŠ›å›¾
   - è¾“å…¥ï¼šSAMå›¾åƒç‰¹å¾ (256Ã—256Ã—256)
   - è¾“å‡ºï¼šç›®æ ‡ç‚¹åæ ‡ + çƒ­åŠ›å›¾
   - æ¶æ„ï¼šTransformerè§£ç å™¨ + ä¸Šé‡‡æ ·å±‚

2. **ROIHeadMLP** (`models.py`)
   - åŠŸèƒ½ï¼šROIåˆ†ç±»å¤´ï¼Œåˆ¤æ–­å€™é€‰æ¡†æ˜¯å¦ä¸ºç›®æ ‡
   - è¾“å…¥ï¼šSAMç‰¹å¾ + å€™é€‰æ¡† + CLIPç‰¹å¾ï¼ˆç¤ºä¾‹æ¡†æˆ–æ–‡æœ¬ï¼‰
   - è¾“å‡ºï¼šåˆ†ç±»logitsï¼ˆç›®æ ‡/èƒŒæ™¯ï¼‰
   - æ¶æ„ï¼šROI Align + MLP

---

## 3. ä¸»è¦æ–‡ä»¶çš„ä½œç”¨å’Œè¾“å…¥è¾“å‡º

### é˜¶æ®µ1ï¼šæ•°æ®é¢„å¤„ç† (`1_generate_data.py`)

**åŠŸèƒ½**ï¼šç”Ÿæˆè®­ç»ƒæ‰€éœ€çš„æ‰€æœ‰é¢„å¤„ç†æ•°æ®ï¼ˆæ¨ç†æµç¨‹ï¼Œæ— è®­ç»ƒï¼‰

**è¾“å…¥**ï¼š
- å›¾åƒæ•°æ®ï¼š`{dataset_root}/images_384_VarV2/` (FSC147åŸå§‹å›¾åƒ)
- æ ‡æ³¨æ–‡ä»¶ï¼š`{dataset_root}/annotation_FSC147_384_with_gt.json`
- SAMæ¨¡å‹æƒé‡ï¼š`/mnt/mydisk/wjj/Prompt_sam_localization/checkpoint/sam_vit_h_4b8939.pth`
- CLIPæ¨¡å‹æƒé‡ï¼š`{project_root}/ops/foundation_models/clip/ViT-B-32.pt`

**è¾“å‡º**ï¼š
1. `{project_root}/data/fsc147/sam/all_data_vith_v5_fix.pth`
   - åŒ…å«ï¼šå›¾åƒåã€æ ‡æ³¨ç‚¹ã€ç¤ºä¾‹æ¡†ã€å®½é«˜ã€ç±»åˆ«åã€SAMå›¾åƒç‰¹å¾ã€CLIPç¤ºä¾‹æ¡†ç‰¹å¾
2. `{project_root}/data/fsc147/sam/segment_anything_data_vith.pth`
   - åŒ…å«ï¼šSAMç½‘æ ¼ç‚¹æ¨ç†åçš„é¢„æµ‹æ¡†ã€æ©ç ä¸­å¿ƒç‚¹ã€IoUç½®ä¿¡åº¦
3. `{project_root}/data/fsc147/sam/pseudo_boxes_data_vith.pth`
   - åŒ…å«ï¼šåŸºäºçœŸå®æ ‡æ³¨ç‚¹ç”Ÿæˆçš„ä¼ªæ ‡ç­¾è¾¹ç•Œæ¡†
4. `{project_root}/data/fsc147/clip_text_prompt.pth`
   - åŒ…å«ï¼šç±»åˆ«å â†’ CLIPæ–‡æœ¬ç‰¹å¾å‘é‡ï¼ˆ512ç»´ï¼‰çš„æ˜ å°„

**å…³é”®æ“ä½œ**ï¼š
- SAMå›¾åƒç¼–ç å™¨æå–ç‰¹å¾
- ç½‘æ ¼ç‚¹æ¨ç†ç”Ÿæˆå€™é€‰æ¡†
- åŸºäºæ ‡æ³¨ç‚¹ç”Ÿæˆä¼ªæ ‡ç­¾
- CLIPæå–ç¤ºä¾‹æ¡†å›¾åƒç‰¹å¾
- CLIPæå–ç±»åˆ«æ–‡æœ¬ç‰¹å¾

---

### é˜¶æ®µ2ï¼šè®­ç»ƒç‚¹è§£ç å™¨ (`2_train_heatmap.py`)

**åŠŸèƒ½**ï¼šè®­ç»ƒPointDecoderæ¨¡å‹ï¼Œå­¦ä¹ é¢„æµ‹ç›®æ ‡å…³é”®ç‚¹

**è¾“å…¥**ï¼š
- `{project_root}/data/fsc147/sam/all_data_vith_v5.pth`
- `{project_root}/data/fsc147/sam/segment_anything_data_vith.pth`
- SAMæ¨¡å‹ï¼ˆç”¨äºç‰¹å¾æå–ï¼‰

**è¾“å‡º**ï¼š
- `{project_root}/data/fsc147/checkpoints/point_decoder_vith_v5.pth`
  - åŒ…å«ï¼šPointDecoderæ¨¡å‹æƒé‡ + ä¼˜åŒ–å™¨çŠ¶æ€

**è®­ç»ƒæµç¨‹**ï¼š
1. åŠ è½½SAMç‰¹å¾å’Œæ ‡æ³¨ç‚¹
2. ç”ŸæˆçœŸå®çƒ­åŠ›å›¾ï¼ˆåŸºäºæ ‡æ³¨ç‚¹+SAMé¢„æµ‹ç‚¹ï¼‰
3. PointDecoderé¢„æµ‹çƒ­åŠ›å›¾
4. MSEæŸå¤±è®­ç»ƒï¼ˆ50000æ¬¡è¿­ä»£ï¼‰

---

### é˜¶æ®µ3ï¼šæå–å€™é€‰æ¡†å’ŒCLIPç‰¹å¾ (`3_extract_proposals.py`)

**åŠŸèƒ½**ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„PointDecoderæå–å€™é€‰æ¡†ï¼Œå¹¶æå–CLIPç‰¹å¾ï¼ˆæ”¯æŒå¤šGPUåˆ†å¸ƒå¼ï¼‰

**è¾“å…¥**ï¼š
- `{project_root}/data/fsc147/sam/all_data_vith_v5.pth`
- `{project_root}/data/fsc147/checkpoints/point_decoder_vith.pth` (é˜¶æ®µ2çš„è¾“å‡º)
- SAMæ¨¡å‹
- CLIPæ¨¡å‹

**è¾“å‡º**ï¼š
- `{project_root}/data/fsc147/sam/all_predictions_vith.pth`
  - åŒ…å«ï¼šæ¯å¼ å›¾åƒçš„é¢„æµ‹æ¡†ã€é¢„æµ‹ç‚¹ã€ç½®ä¿¡åº¦åˆ†æ•°ã€CLIPåŒºåŸŸç‰¹å¾

**å¤„ç†æµç¨‹**ï¼š
1. PointDecoderæ¨ç†ç”Ÿæˆå€™é€‰ç‚¹
2. SAMåŸºäºå€™é€‰ç‚¹ç”Ÿæˆå€™é€‰æ¡†
3. CLIPæå–å€™é€‰æ¡†çš„å›¾åƒç‰¹å¾
4. åˆ†å¸ƒå¼å¤„ç†ï¼ˆå¤šGPUå¹¶è¡Œï¼‰

**è¿è¡Œæ–¹å¼**ï¼š
```bash
torchrun --master_port 17673 --nproc_per_node=4 3_extract_proposals.py
```

---

### é˜¶æ®µ4ï¼šè®­ç»ƒROIåˆ†ç±»å¤´

#### 4.1 Few-shotæ¨¡å¼ (`4_1_train_roi_head.py`)

**åŠŸèƒ½**ï¼šè®­ç»ƒROIHeadMLPï¼Œä½¿ç”¨CLIPç¤ºä¾‹æ¡†ç‰¹å¾è¿›è¡Œåˆ†ç±»

**è¾“å…¥**ï¼š
- `{project_root}/data/fsc147/sam/all_data_vith_v5_fix.pth`
- `{project_root}/data/fsc147/sam/all_predictions_vith.pth`
- `{project_root}/data/fsc147/sam/pseudo_boxes_data_vith.pth`
- `{project_root}/data/fsc147/clip_text_prompt.pth`
- COCOæ ‡æ³¨ï¼š`{dataset_root}/instances_test_val_bin.json`

**è¾“å‡º**ï¼š
- `{project_root}/data/fsc147/checkpoints/cls_head/ckpt/{run_name}/`
  - åŒ…å«ï¼šROIHeadMLPæ¨¡å‹æƒé‡ã€è®­ç»ƒæ—¥å¿—ã€è¯„ä¼°ç»“æœ

**è®­ç»ƒæµç¨‹**ï¼š
1. åŠ è½½æ‰€æœ‰é¢„å¤„ç†æ•°æ®
2. è®­ç»ƒROIHeadMLPï¼ˆ10000æ¬¡è¿­ä»£ï¼‰
3. æ¯1000æ¬¡è¿­ä»£è¯„ä¼°ï¼ˆval/testé›†ï¼‰
4. è¾“å‡ºæ£€æµ‹æŒ‡æ ‡ï¼ˆAP, AP50ç­‰ï¼‰å’Œè®¡æ•°æŒ‡æ ‡ï¼ˆMAE, RMSE, NAE, SREï¼‰

**è¿è¡Œæ–¹å¼**ï¼š
```bash
python 4_1_train_roi_head.py --wandb --entity zzhuang  # few-shot
python 4_1_train_roi_head.py --wandb --entity zzhuang --zeroshot  # zero-shot
```

#### 4.2 ViLDæ¨¡å¼ (`4_2_train_vild.py`)

**åŠŸèƒ½**ï¼šè®­ç»ƒViLDé£æ ¼çš„ROIåˆ†ç±»å¤´ï¼ˆä½¿ç”¨ç±»åˆ«ä¸­å¿ƒç‰¹å¾ï¼‰

**è¾“å…¥/è¾“å‡º**ï¼šä¸4.1ç±»ä¼¼ï¼Œä½†ä½¿ç”¨ä¸åŒçš„åˆ†ç±»å¤´æ¶æ„

---

## 4. è®­ç»ƒæµç¨‹å’Œæ¨ç†æµç¨‹

### 4.1 å®Œæ•´è®­ç»ƒæµç¨‹

```
é˜¶æ®µ1: æ•°æ®é¢„å¤„ç† (1_generate_data.py)
  â†“
  [ç”ŸæˆSAMç‰¹å¾ã€CLIPç‰¹å¾ã€ä¼ªæ ‡ç­¾]
  â†“
é˜¶æ®µ2: è®­ç»ƒç‚¹è§£ç å™¨ (2_train_heatmap.py)
  â†“
  [è®­ç»ƒPointDecoderï¼Œå­¦ä¹ é¢„æµ‹ç›®æ ‡ç‚¹]
  â†“
é˜¶æ®µ3: æå–å€™é€‰æ¡† (3_extract_proposals.py)
  â†“
  [ä½¿ç”¨PointDecoderæå–å€™é€‰æ¡†+CLIPç‰¹å¾]
  â†“
é˜¶æ®µ4: è®­ç»ƒROIåˆ†ç±»å¤´ (4_1_train_roi_head.py æˆ– 4_2_train_vild.py)
  â†“
  [è®­ç»ƒROIHeadï¼Œå®Œæˆæœ€ç»ˆè®¡æ•°æ¨¡å‹]
```

### 4.2 æ¨ç†æµç¨‹ï¼ˆä»¥demoä¸ºä¾‹ï¼‰

1. **åŠ è½½æ¨¡å‹**ï¼š
   - SAMæ¨¡å‹ï¼ˆç‰¹å¾æå–ï¼‰
   - PointDecoderï¼ˆç‚¹é¢„æµ‹ï¼‰
   - ROIHeadMLPï¼ˆåˆ†ç±»ï¼‰

2. **å¤„ç†è¾“å…¥**ï¼š
   - è¾“å…¥å›¾åƒ â†’ SAMæå–ç‰¹å¾
   - PointDecoderé¢„æµ‹ç›®æ ‡ç‚¹
   - SAMåŸºäºç‚¹ç”Ÿæˆå€™é€‰æ¡†
   - ROIHeadMLPåˆ†ç±»å€™é€‰æ¡†

3. **è¾“å‡ºç»“æœ**ï¼š
   - ç›®æ ‡æ¡†åæ ‡
   - ç½®ä¿¡åº¦åˆ†æ•°
   - è®¡æ•°ç»“æœ

---

## 5. å½“å‰ä»£ç çš„ä¸è¶³

### 5.1 è®­ç»ƒæµç¨‹é—®é¢˜

1. **4ä¸ªè®­ç»ƒé˜¶æ®µéœ€è¦æ‰‹åŠ¨åˆ‡æ¢è„šæœ¬**
   - é—®é¢˜ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹çš„Pythonè„šæœ¬ï¼Œéœ€è¦æ‰‹åŠ¨ä¾æ¬¡è¿è¡Œ
   - å½±å“ï¼šæ— æ³•ä¸€é”®å¯åŠ¨å®Œæ•´è®­ç»ƒæµç¨‹ï¼Œå®¹æ˜“é—æ¼æ­¥éª¤æˆ–é¡ºåºé”™è¯¯
   - ç¤ºä¾‹ï¼š
     ```bash
     # éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ4ä¸ªå‘½ä»¤
     python 1_generate_data.py
     python 2_train_heatmap.py
     torchrun 3_extract_proposals.py
     python 4_1_train_roi_head.py
     ```

2. **é˜¶æ®µé—´ä¾èµ–å…³ç³»ä¸æ˜ç¡®**
   - é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å‰ç½®é˜¶æ®µçš„è¾“å‡ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - å½±å“ï¼šå¦‚æœå‰ç½®é˜¶æ®µæœªå®Œæˆï¼Œåç»­é˜¶æ®µä¼šæŠ¥é”™ï¼Œéš¾ä»¥å®šä½é—®é¢˜

3. **æ— æ³•æ–­ç‚¹ç»­è®­**
   - é—®é¢˜ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä»å¤´å¼€å§‹ï¼Œæ— æ³•è·³è¿‡å·²å®Œæˆçš„é˜¶æ®µ
   - å½±å“ï¼šé‡æ–°è®­ç»ƒæ—¶æµªè´¹æ—¶é—´

### 5.2 æ•°æ®é›†æ›¿æ¢é—®é¢˜

1. **ç¡¬ç¼–ç è·¯å¾„éå¸ƒä»£ç **
   - é—®é¢˜ï¼šæ‰€æœ‰è·¯å¾„éƒ½ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼ˆå¦‚`/mnt/mydisk/wjj/PseCo-main/`ï¼‰
   - å½±å“ï¼šæ›´æ¢æ•°æ®é›†æˆ–æ›´æ¢ç¯å¢ƒéœ€è¦ä¿®æ”¹å¤§é‡æ–‡ä»¶
   - ç¤ºä¾‹è·¯å¾„ï¼š
     - `project_root = '/mnt/mydisk/wjj/PseCo-main'`
     - `dataset_root = '/mnt/mydisk/wjj/dataset/FSC_147/'`
     - `sam_checkpoint = '/mnt/mydisk/wjj/Prompt_sam_localization/checkpoint/sam_vit_h_4b8939.pth'`

2. **æ•°æ®é›†ç»“æ„å‡è®¾å›ºå®š**
   - é—®é¢˜ï¼šä»£ç å‡è®¾æ•°æ®é›†ç»“æ„ä¸ºFSC147æ ¼å¼
   - å½±å“ï¼šé€‚é…æ–°æ•°æ®é›†éœ€è¦å¤§é‡ä¿®æ”¹ä»£ç 

3. **é…ç½®æ–‡ä»¶ç¼ºå¤±**
   - é—®é¢˜ï¼šæ²¡æœ‰ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ç®¡ç†è·¯å¾„å’Œè¶…å‚æ•°
   - å½±å“ï¼šé…ç½®åˆ†æ•£åœ¨å„ä¸ªè„šæœ¬ä¸­ï¼Œéš¾ä»¥ç®¡ç†

### 5.3 å…¶ä»–é—®é¢˜

1. **æ—¥å¿—å’Œé”™è¯¯å¤„ç†ä¸å®Œå–„**
   - éƒ¨åˆ†è„šæœ¬ç¼ºå°‘è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
   - é”™è¯¯å¤„ç†ä¸å¤Ÿå¥å£®

2. **ä»£ç é‡å¤**
   - å¤šä¸ªè„šæœ¬ä¸­æœ‰é‡å¤çš„æ•°æ®åŠ è½½ã€æ¨¡å‹åˆå§‹åŒ–ä»£ç 

3. **ç¼ºå°‘è¿›åº¦ä¿å­˜æœºåˆ¶**
   - é˜¶æ®µ3ï¼ˆæå–å€™é€‰æ¡†ï¼‰è™½ç„¶æœ‰ä¸­é—´ä¿å­˜ï¼Œä½†å…¶ä»–é˜¶æ®µç¼ºå°‘

---

## 6. æ•´åˆæ–¹æ¡ˆï¼šå®ç°"4é˜¶æ®µè®­ç»ƒä¾æ¬¡å¯åœ+æ”¯æŒæ–°æ•°æ®é›†æ›¿æ¢"

### 6.1 æ–¹æ¡ˆæ¦‚è¿°

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„è®­ç»ƒå…¥å£è„šæœ¬ï¼Œå®ç°ï¼š
1. **ä¸€é”®å¯åŠ¨4é˜¶æ®µè®­ç»ƒ**ï¼šè‡ªåŠ¨æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰é˜¶æ®µ
2. **æ–­ç‚¹ç»­è®­**ï¼šè‡ªåŠ¨æ£€æµ‹å·²å®Œæˆé˜¶æ®µï¼Œè·³è¿‡å·²å®Œæˆçš„æ­¥éª¤
3. **é…ç½®åŒ–æ•°æ®é›†**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†æ‰€æœ‰è·¯å¾„å’Œå‚æ•°
4. **ä¾èµ–æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æŸ¥å‰ç½®é˜¶æ®µçš„è¾“å‡ºæ–‡ä»¶

### 6.2 å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šä¸»æ§åˆ¶å™¨è„šæœ¬ + é…ç½®æ–‡ä»¶

**æ–‡ä»¶ç»“æ„**ï¼š
```
PseCo/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ default_config.yaml          # é»˜è®¤é…ç½®ï¼ˆFSC147ï¼‰
â”‚   â””â”€â”€ fscd_lvis_config.yaml        # FSCD-LVISé…ç½®ç¤ºä¾‹
â”œâ”€â”€ train_pipeline.py                 # ä¸»è®­ç»ƒå…¥å£
â”œâ”€â”€ stages/
â”‚   â”œâ”€â”€ stage1_generate_data.py      # é˜¶æ®µ1ï¼ˆé‡æ„ï¼‰
â”‚   â”œâ”€â”€ stage2_train_heatmap.py      # é˜¶æ®µ2ï¼ˆé‡æ„ï¼‰
â”‚   â”œâ”€â”€ stage3_extract_proposals.py   # é˜¶æ®µ3ï¼ˆé‡æ„ï¼‰
â”‚   â””â”€â”€ stage4_train_roi_head.py    # é˜¶æ®µ4ï¼ˆé‡æ„ï¼‰
â””â”€â”€ utils/
    â”œâ”€â”€ config_loader.py              # é…ç½®åŠ è½½å™¨
    â”œâ”€â”€ path_manager.py               # è·¯å¾„ç®¡ç†å™¨
    â””â”€â”€ stage_checker.py              # é˜¶æ®µå®Œæˆæ£€æŸ¥å™¨
```

**é…ç½®æ–‡ä»¶æ ¼å¼** (`config/default_config.yaml`)ï¼š
```yaml
# é¡¹ç›®æ ¹ç›®å½•
project_root: "/mnt/mydisk/wjj/PseCo-main"

# æ•°æ®é›†é…ç½®
dataset:
  name: "fsc147"
  root: "/mnt/mydisk/wjj/dataset/FSC_147"
  annotation_file: "{dataset.root}/annotation_FSC147_384_with_gt.json"
  image_dir: "{dataset.root}/images_384_VarV2"
  coco_annotation: "{dataset.root}/instances_test_val_bin.json"

# æ¨¡å‹è·¯å¾„
models:
  sam_checkpoint: "/mnt/mydisk/wjj/Prompt_sam_localization/checkpoint/sam_vit_h_4b8939.pth"
  clip_checkpoint: "{project_root}/ops/foundation_models/clip/ViT-B-32.pt"
  sam_arch: "vith"  # vitb, vitl, vith

# è¾“å‡ºè·¯å¾„
outputs:
  data_dir: "{project_root}/data/{dataset.name}/sam"
  checkpoint_dir: "{project_root}/data/{dataset.name}/checkpoints"
  log_dir: "{project_root}/logs"

# è®­ç»ƒé…ç½®
training:
  stage1:
    enabled: true
    max_iter: null  # æ— è®­ç»ƒ
  stage2:
    enabled: true
    max_iter: 50000
    batch_size: 64
    lr: 0.0001
  stage3:
    enabled: true
    num_gpus: 4
    master_port: 17673
  stage4:
    enabled: true
    max_iter: 10000
    batch_size: 32
    lr: 0.0001
    mode: "fewshot"  # fewshot or zeroshot or vild
```

**ä¸»è®­ç»ƒè„šæœ¬** (`train_pipeline.py`)ï¼š
```python
"""
ç»Ÿä¸€è®­ç»ƒå…¥å£ï¼šè‡ªåŠ¨æ‰§è¡Œ4ä¸ªè®­ç»ƒé˜¶æ®µ
"""
import argparse
from utils.config_loader import load_config
from utils.stage_checker import check_stage_completion
from stages.stage1_generate_data import run_stage1
from stages.stage2_train_heatmap import run_stage2
from stages.stage3_extract_proposals import run_stage3
from stages.stage4_train_roi_head import run_stage4

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--config', type=str, default='config/default_config.yaml')
    parser.add_argument('--stages', type=str, nargs='+', default=['1', '2', '3', '4'],
                        help='è¦æ‰§è¡Œçš„é˜¶æ®µï¼Œå¦‚: --stages 1 2 3 4')
    parser.add_argument('--resume', action='store_true', help='æ–­ç‚¹ç»­è®­ï¼šè·³è¿‡å·²å®Œæˆçš„é˜¶æ®µ')
    args = parser.parse_args()
    
    # åŠ è½½é…ç½®
    config = load_config(args.config)
    
    # å®šä¹‰é˜¶æ®µæ˜ å°„
    stage_funcs = {
        '1': (run_stage1, 'æ•°æ®é¢„å¤„ç†'),
        '2': (run_stage2, 'è®­ç»ƒç‚¹è§£ç å™¨'),
        '3': (run_stage3, 'æå–å€™é€‰æ¡†'),
        '4': (run_stage4, 'è®­ç»ƒROIåˆ†ç±»å¤´'),
    }
    
    # æ‰§è¡Œé˜¶æ®µ
    for stage_id in args.stages:
        if stage_id not in stage_funcs:
            print(f"âŒ æœªçŸ¥é˜¶æ®µ: {stage_id}")
            continue
            
        func, name = stage_funcs[stage_id]
        
        # æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
        if args.resume and check_stage_completion(config, stage_id):
            print(f"â­ï¸  é˜¶æ®µ{stage_id} ({name}) å·²å®Œæˆï¼Œè·³è¿‡")
            continue
        
        print(f"ğŸš€ å¼€å§‹æ‰§è¡Œé˜¶æ®µ{stage_id}: {name}")
        try:
            func(config)
            print(f"âœ… é˜¶æ®µ{stage_id} ({name}) å®Œæˆ")
        except Exception as e:
            print(f"âŒ é˜¶æ®µ{stage_id} ({name}) å¤±è´¥: {e}")
            if not args.resume:
                raise
            print("âš ï¸  ç»§ç»­æ‰§è¡Œä¸‹ä¸€é˜¶æ®µ...")

if __name__ == '__main__':
    main()
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# ä¸€é”®æ‰§è¡Œæ‰€æœ‰é˜¶æ®µ
python train_pipeline.py --config config/default_config.yaml

# åªæ‰§è¡Œç‰¹å®šé˜¶æ®µ
python train_pipeline.py --stages 3 4

# æ–­ç‚¹ç»­è®­ï¼ˆè‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„é˜¶æ®µï¼‰
python train_pipeline.py --resume

# ä½¿ç”¨æ–°æ•°æ®é›†é…ç½®
python train_pipeline.py --config config/fscd_lvis_config.yaml
```

#### æ–¹æ¡ˆBï¼šç®€åŒ–ç‰ˆï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

å¦‚æœä¸æƒ³å¤§å¹…é‡æ„ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç®€å•çš„åŒ…è£…è„šæœ¬ï¼š

**æ–‡ä»¶ç»“æ„**ï¼š
```
PseCo/
â”œâ”€â”€ config.yaml                      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ run_all_stages.py                # ç®€å•åŒ…è£…è„šæœ¬
â””â”€â”€ fsc147/                          # åŸæœ‰æ–‡ä»¶ä¿æŒä¸å˜
```

**é…ç½®æ–‡ä»¶** (`config.yaml`)ï¼š
```yaml
project_root: "/mnt/mydisk/wjj/PseCo-main"
dataset_root: "/mnt/mydisk/wjj/dataset/FSC_147"
sam_checkpoint: "/mnt/mydisk/wjj/Prompt_sam_localization/checkpoint/sam_vit_h_4b8939.pth"
```

**åŒ…è£…è„šæœ¬** (`run_all_stages.py`)ï¼š
```python
import subprocess
import sys
import yaml
import os

def load_config():
    with open('config.yaml', 'r') as f:
        return yaml.safe_load(f)

def run_stage(stage_num, config):
    """è¿è¡ŒæŒ‡å®šé˜¶æ®µ"""
    stages = {
        1: ('1_generate_data.py', []),
        2: ('2_train_heatmap.py', []),
        3: ('3_extract_proposals.py', ['torchrun', '--master_port', '17673', '--nproc_per_node=4']),
        4: ('4_1_train_roi_head.py', ['--wandb']),
    }
    
    script, args = stages[stage_num]
    script_path = f'fsc147/{script}'
    
    # è®¾ç½®ç¯å¢ƒå˜é‡ä¼ é€’é…ç½®
    env = os.environ.copy()
    env['PROJECT_ROOT'] = config['project_root']
    env['DATASET_ROOT'] = config['dataset_root']
    # ... å…¶ä»–é…ç½®
    
    cmd = args + [script_path]
    subprocess.run(cmd, env=env, check=True)

if __name__ == '__main__':
    config = load_config()
    stages = sys.argv[1:] if len(sys.argv) > 1 else ['1', '2', '3', '4']
    
    for stage in stages:
        print(f"æ‰§è¡Œé˜¶æ®µ {stage}...")
        run_stage(int(stage), config)
```

### 6.3 æ•°æ®é›†æ›¿æ¢æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šé…ç½®æ–‡ä»¶ + è·¯å¾„æ¨¡æ¿

åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨æ¨¡æ¿å˜é‡ï¼Œæ”¯æŒä¸åŒæ•°æ®é›†ï¼š

```yaml
datasets:
  fsc147:
    root: "/path/to/fsc147"
    annotation: "{root}/annotation_FSC147_384_with_gt.json"
    images: "{root}/images_384_VarV2"
  
  fscd_lvis:
    root: "/path/to/fscd_lvis"
    annotation: "{root}/annotation.json"
    images: "{root}/images"
```

#### æ–¹æ¡ˆ2ï¼šæ•°æ®é›†é€‚é…å™¨æ¨¡å¼

åˆ›å»ºç»Ÿä¸€çš„æ•°æ®é›†æ¥å£ï¼Œä¸åŒæ•°æ®é›†å®ç°é€‚é…å™¨ï¼š

```python
# utils/dataset_adapter.py
class DatasetAdapter:
    def get_annotation_file(self):
        raise NotImplementedError
    
    def get_image_dir(self):
        raise NotImplementedError
    
    def load_annotations(self):
        raise NotImplementedError

class FSC147Adapter(DatasetAdapter):
    def __init__(self, root):
        self.root = root
        self.annotation_file = f"{root}/annotation_FSC147_384_with_gt.json"
        self.image_dir = f"{root}/images_384_VarV2"
    
    def load_annotations(self):
        # FSC147ç‰¹å®šçš„åŠ è½½é€»è¾‘
        pass

class FSCDLVISAdapter(DatasetAdapter):
    def __init__(self, root):
        self.root = root
        # FSCD-LVISç‰¹å®šçš„è·¯å¾„
        pass
```

### 6.4 æ¨èå®æ–½æ–¹æ¡ˆ

**å»ºè®®é‡‡ç”¨æ–¹æ¡ˆAï¼ˆä¸»æ§åˆ¶å™¨+é…ç½®æ–‡ä»¶ï¼‰**ï¼ŒåŸå› ï¼š
1. âœ… å®Œå…¨è§£å†³"ä¸€é”®è¿è¡Œ"é—®é¢˜
2. âœ… å®Œå…¨è§£å†³"æ•°æ®é›†æ›¿æ¢"é—®é¢˜
3. âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
4. âœ… æ”¯æŒæ–­ç‚¹ç»­è®­
5. âœ… ä¾¿äºæ‰©å±•æ–°æ•°æ®é›†

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»ºé…ç½®æ–‡ä»¶å’Œå·¥å…·ç±»ï¼ˆ`config/`, `utils/`ï¼‰
2. é‡æ„å„é˜¶æ®µè„šæœ¬ï¼Œæå–ä¸ºå‡½æ•°ï¼ˆ`stages/`ï¼‰
3. åˆ›å»ºä¸»è®­ç»ƒå…¥å£ï¼ˆ`train_pipeline.py`ï¼‰
4. æµ‹è¯•å®Œæ•´æµç¨‹
5. ç¼–å†™ä½¿ç”¨æ–‡æ¡£

---

## 7. æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… åŠŸèƒ½å®Œæ•´ï¼š4ä¸ªè®­ç»ƒé˜¶æ®µéƒ½å·²å®ç°
- âŒ æµç¨‹åˆ†æ•£ï¼šéœ€è¦æ‰‹åŠ¨åˆ‡æ¢è„šæœ¬
- âŒ è·¯å¾„ç¡¬ç¼–ç ï¼šéš¾ä»¥æ›¿æ¢æ•°æ®é›†
- âŒ ç¼ºå°‘é…ç½®ç®¡ç†ï¼šå‚æ•°åˆ†æ•£åœ¨å„è„šæœ¬

### æ”¹è¿›ç›®æ ‡
- âœ… ä¸€é”®å¯åŠ¨4é˜¶æ®µè®­ç»ƒ
- âœ… æ”¯æŒæ–­ç‚¹ç»­è®­
- âœ… é…ç½®æ–‡ä»¶ç®¡ç†è·¯å¾„å’Œå‚æ•°
- âœ… æ˜“äºæ›¿æ¢æ–°æ•°æ®é›†

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. åˆ›å»ºé…ç½®æ–‡ä»¶ç³»ç»Ÿ
2. é‡æ„å„é˜¶æ®µä¸ºå‡½æ•°æ¨¡å—
3. å®ç°ä¸»è®­ç»ƒæ§åˆ¶å™¨
4. æµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹
